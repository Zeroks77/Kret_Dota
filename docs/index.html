<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Kret&#39;s EU Dota League - Reports</title>
<link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
<link rel='icon' href='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect width=%22100%22 height=%22100%22 rx=%2218%22 fill=%22%23121832%22/%3E%3Ctext x=%2250%25%22 y=%2258%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2256%22 fill=%22%239ec7ff%22%3ED%3C/text%3E%3C/svg%3E'>
<style>
:root{--bg:#0b1020;--panel:#121832;--muted:#9aa3b2;--text:#eef1f7;--accent:#6da6ff;--chip:#1a2142;--border:rgba(255,255,255,.08)}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #172045, transparent 60%), var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;height:100vh;display:flex}
.sidebar{width:360px;min-width:280px;max-width:420px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border-right:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:12px}
.brand h1{font-size:20px;margin:0}
.sub{color:var(--muted);font-size:13px}
.filters{display:flex;flex-wrap:wrap;gap:6px}
.btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0e1533;color:var(--text);cursor:pointer;font-size:12px}
.btn.active{outline:2px solid rgba(109,166,255,.6)}
.search{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);outline:none}
.list{margin:0;padding:0;list-style:none;overflow:auto;border:1px solid var(--border);border-radius:12px;flex:1;background:rgba(255,255,255,.02)}
.item a{display:block;padding:10px 12px;color:var(--text);text-decoration:none;border-bottom:1px solid rgba(255,255,255,.06)}
.item a:hover{background:rgba(255,255,255,.06)}
.item.active a{background:rgba(109,166,255,.18)}
.viewer{flex:1;display:flex;flex-direction:column}
.viewerbar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.03)}
.viewerbar .title{font-weight:600}
.viewerbar .nav{display:flex;gap:8px}
.nav .btn{padding:6px 10px}
iframe{border:0;flex:1;width:100%}
a{color:var(--accent)}
.has-hover{position:relative}
.hovercard{display:none;position:absolute;left:0;top:100%;margin-top:6px;z-index:5;min-width:260px;max-width:420px;padding:10px;border-radius:10px;background:rgba(15,20,40,.96);border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.35)}
.hovercard .title{font-weight:600;color:var(--muted);font-size:12px;margin-bottom:6px}
.hovercard a{display:inline-block;margin:2px 6px 2px 0;background:var(--chip);padding:3px 8px;border-radius:999px}
.has-hover:hover > .hovercard{display:block}
.has-hover.open > .hovercard{display:block}
/* Hero gallery inside hovercard */
.hovercard .heroes{max-width:520px}
/* Picklists: always white with black text (future-proof if selects are added) */
select{padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.25);background:#ffffff;color:#000000}
select option{background:#ffffff;color:#000000}
select:disabled{background:#f2f2f2;color:#666;opacity:1}
/* Loading spinner for sidebar */
.ix-spinner{display:none;align-items:center;gap:8px;color:var(--muted);font-size:12px}
.ix-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:bd 1s infinite}
.ix-dot:nth-child(2){animation-delay:.15s}.ix-dot:nth-child(3){animation-delay:.3s}
@keyframes bd{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
/* Focus visible for keyboard users */
.btn:focus-visible, button:focus-visible, a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px }
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
</style>
</head>
<body>
  <aside class='sidebar'>
    <div class='brand'>
      <h1>Reports - Kret&#39;s EU Dota League</h1>
      <div class='sub'>Pick a run or filter by range.</div>
    </div>
    <div id='ixSpin' class='ix-spinner'><div class='ix-dot'></div><div class='ix-dot'></div><div class='ix-dot'></div><span>Loading list…</span></div>
  <!-- Filters removed; Dynamic view is available as a pinned list entry below -->
  <label for='q' class='sr-only'>Search reports by name, date, or range</label>
  <input id='q' class='search' type='text' placeholder='Search (date/range) ...' aria-label='Search reports by name, date, or range'>
    <ul id='list' class='list tree'>
      <li class="leaf item" data-range="dynamic" data-time="9223372036854775807"><a href="./dynamic.html">Dynamic view (custom timeframe)</a></li>
      <li class="node" id="node-monthly"><details open>
        <summary>📅 Monthly Reports</summary>
        <ul class="children" id="tree-monthly"></ul>
      </details></li>
      <li class="node" id="node-patch"><details open>
        <summary>🧩 Patch Reports</summary>
        <ul class="children" id="tree-patch"></ul>
      </details></li>
      <li class="node" id="node-user"><details open>
        <summary>👤 User Reports</summary>
        <ul class="children" id="tree-user"></ul>
      </details></li>
      <li class="node" id="node-league"><details open>
        <summary>🏆 Leagues</summary>
        <ul class="children" id="tree-league"></ul>
      </details></li>
    </ul>
  <div class='sub' style='margin-top:8px;opacity:.9'>Data and imagery powered by <a href='https://www.opendota.com/' target='_blank' rel='noopener'>OpenDota</a>.</div>
  <div class='sub' style='margin-top:4px;opacity:.95'>Read the <a href='./guide/'>project documentation</a>.</div>
  </aside>

  <main class='viewer'>
    <div class='viewerbar'>
      <div class='title' id='viewerTitle'>-</div>
      <div class='nav'>
        <button class='btn' id='prevBtn' title='Previous (ArrowUp)'><- Previous</button>
        <button class='btn' id='nextBtn' title='Next (ArrowDown)'>Next -></button>
        <a class='btn' id='openNew' target='_blank' rel='noopener'>Open in new tab</a>
      </div>
    </div>
    
    <iframe id='frame' src='about:blank' loading='eager' referrerpolicy='no-referrer'></iframe>
  </main>

<script>
(function(){
  const list = document.getElementById('list');
  let items = Array.from(list.querySelectorAll('.leaf.item'));
  const q = document.getElementById('q');
  const frame = document.getElementById('frame');
  const title = document.getElementById('viewerTitle');
  const openNew = document.getElementById('openNew');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  let selIndex = -1;

  function vis(){ return items.filter(li => li.style.display !== 'none'); }
  function txt(li){ const a=li.querySelector('a'); return a ? a.textContent.trim() : li.getAttribute('data-range'); }

  function apply(){
    const term = q.value.trim().toLowerCase(); let n=0;
    items.forEach(li=>{
      const t = txt(li).toLowerCase();
      const ok = (!term || t.includes(term));
      li.style.display = ok ? '' : 'none'; if (ok) n++;
    });
    // Show/hide and auto-open nodes based on visible children
    document.querySelectorAll('.node').forEach(node=>{
      const ul = node.querySelector('ul.children'); const details = node.querySelector('details'); if(!ul||!details) return;
      const anyChildVisible = Array.from(ul.querySelectorAll(':scope > li.leaf')).some(li => li.style.display !== 'none');
      node.style.display = anyChildVisible ? '' : 'none';
      if (anyChildVisible && term){ details.open = true; }
    });
    if (n===0){ selIndex=-1; frame.src='about:blank'; title.textContent='No results'; openNew.removeAttribute('href'); }
    else if (selIndex<0){ select(0); }
    sync();
  }
  function select(i){
    const v = vis(); if (!v.length) return;
    if (i<0) i=0; if (i>=v.length) i=v.length-1;
    v.forEach(li => li.classList.remove('active'));
    const li=v[i]; li.classList.add('active');
    const a=li.querySelector('a');
    if (a){ const href=a.getAttribute('href'); frame.src=href; title.textContent=a.textContent.trim(); openNew.setAttribute('href',href); history.replaceState(null,'','#file='+encodeURIComponent(href)); }
    selIndex=i; li.scrollIntoView({block:'nearest'}); sync();
  }
  function sync(){ const v=vis(); prevBtn.disabled = (selIndex<=0 || !v.length); nextBtn.disabled = (selIndex>=v.length-1 || !v.length); }

  function wireItemClicks(){
    items.forEach(li=>li.addEventListener('click', e=>{e.preventDefault(); const v=vis(); const idx=v.indexOf(li); if (idx>=0) select(idx);}));
  }
  wireItemClicks();
  q.addEventListener('input', apply);
  prevBtn.addEventListener('click', ()=> select(selIndex-1));
  nextBtn.addEventListener('click', ()=> select(selIndex+1));
  document.addEventListener('keydown', ev=>{ if (ev.key==='ArrowUp'){ev.preventDefault(); select(selIndex-1);} if (ev.key==='ArrowDown'){ev.preventDefault(); select(selIndex+1);} });
  // Global: Home focuses the report list and selects current/first visible when not typing
  document.addEventListener('keydown', ev=>{
    if (ev.key !== 'Home') return;
    if (ev.altKey || ev.ctrlKey || ev.metaKey) return;
    const el = document.activeElement; const tag = (el && el.tagName) ? el.tagName.toLowerCase() : '';
    const typing = (tag==='input' || tag==='textarea' || tag==='select' || (el && el.isContentEditable));
    if (typing) return;
    ev.preventDefault();
    const v = vis(); if (!v.length) return;
    list.focus && list.focus();
    // keep current selection if valid; otherwise select first visible
    if (selIndex<0 || selIndex>=v.length) select(0); else select(selIndex);
  });

  function monthName(num){ const M=['January','February','March','April','May','June','July','August','September','October','November','December']; const i=Number(num)-1; return (i>=0&&i<12)?M[i]:String(num); }

  function comparePatch(a,b){
    // Compare numeric parts of versions like 7.39, 7.38b
    const na = String(a).split(/[^0-9]+/).filter(Boolean).map(Number);
    const nb = String(b).split(/[^0-9]+/).filter(Boolean).map(Number);
    const len = Math.max(na.length, nb.length);
    for(let i=0;i<len;i++){ const xa=na[i]||0, xb=nb[i]||0; if(xa!==xb) return xb-xa; }
    return String(b).localeCompare(String(a));
  }

  async function loadReports(){
    const spin = document.getElementById('ixSpin'); if(spin) spin.style.display='flex';
    try {
      async function fetchWithRetry(url, tries=3){
        let lastErr=null; const bust = ()=> (url + (url.includes('?')?'&':'?') + '_ts=' + Date.now());
        for(let i=1;i<=tries;i++){
          try{
            const res = await fetch(bust(), { cache: 'no-store' }); if(!res.ok) throw new Error('HTTP '+res.status);
            return await res.json();
          }catch(e){ lastErr=e; await new Promise(r=>setTimeout(r, 300*i)); }
        }
        throw lastErr||new Error('fetch failed');
      }
      const data = await fetchWithRetry('./reports.json', 3);
      if (!data || !Array.isArray(data.items)) return;
      // Prepare containers
      const ulMonthly = document.getElementById('tree-monthly');
      const ulPatch = document.getElementById('tree-patch');
  const ulUser = document.getElementById('tree-user');
  const ulLeague = document.getElementById('tree-league');
  ulMonthly.innerHTML=''; ulPatch.innerHTML=''; ulUser.innerHTML=''; ulLeague.innerHTML='';
      function safeDate(x){ const t = Date.parse(x?.time||''); return isFinite(t)?t:0; }

  const monthly = data.items.filter(it=> (it.group||'').toLowerCase()==='monthly');
  const patch = data.items.filter(it=> (it.group||'').toLowerCase()==='patch');
  const user = data.items.filter(it=> (it.group||'').toLowerCase()==='user');
  const league = data.items.filter(it=> (it.group||'').toLowerCase()==='league');

      // Helper to normalize hrefs coming from reports.json
      function normHref(h){
        if(!h) return '#';
        const s = String(h).trim();
        if(/^(https?:)?\/\//i.test(s) || s.startsWith('/') || s.startsWith('./')) return s;
        return './'+s; // ensure relative links are rooted from docs/
      }

      // Build Monthly: group by year -> months
      const byYear = new Map();
      for(const it of monthly){
        const sort = String(it.sort||'');
        const yy = sort.match(/^\d{4}/)?.[0] || (String(it.title||'').match(/(\d{4})$/)?.[1]||'');
        const mm = sort.match(/^\d{4}-(\d{2})/)?.[1] || '';
        const y = yy || 'Unknown';
        if(!byYear.has(y)) byYear.set(y, []);
        byYear.get(y).push({...it, _yy:y, _mm:mm});
      }
      const years = Array.from(byYear.keys()).sort((a,b)=> Number(b)-Number(a));
      for(const y of years){
        const itemsY = byYear.get(y).slice().sort((a,b)=> (String(b._mm).localeCompare(String(a._mm))));
        const node = document.createElement('li'); node.className='node';
        const det = document.createElement('details'); det.open = (years[0]===y);
        const sum = document.createElement('summary'); sum.textContent = y;
        const ul = document.createElement('ul'); ul.className='children';
        for(const it of itemsY){
          const li = document.createElement('li'); li.className='leaf item';
          li.setAttribute('data-range','monthly'); li.setAttribute('data-time', String(safeDate(it)));
          const a = document.createElement('a'); a.href = normHref(it.href||'#');
          const label = it._mm ? monthName(it._mm) : (it.title || 'Report');
          a.textContent = label;
          li.appendChild(a); ul.appendChild(li);
        }
        det.appendChild(sum); det.appendChild(ul); node.appendChild(det); ulMonthly.appendChild(node);
      }

      // Build Patch tree (flat list under a single node)
      patch.sort((a,b)=> comparePatch(a.sort||a.title, b.sort||b.title));
      for(const it of patch){
        const li = document.createElement('li'); li.className='leaf item';
        li.setAttribute('data-range','patch'); li.setAttribute('data-time', String(safeDate(it)));
  const a = document.createElement('a'); a.href = normHref(it.href||'#');
        const label = (it.title && !/^\s*$/.test(it.title)) ? it.title : (it.sort? `Patch ${it.sort}` : 'Patch Report');
        a.textContent = label;
        li.appendChild(a); ulPatch.appendChild(li);
      }

      // Build User Reports (flat, newest first)
      user.sort((a,b)=> (safeDate(b) - safeDate(a)));
      for(const it of user){
        const li = document.createElement('li'); li.className='leaf item';
        li.setAttribute('data-range','user'); li.setAttribute('data-time', String(safeDate(it)));
  const a = document.createElement('a'); a.href = normHref(it.href||'#');
        a.textContent = (it.title && !/^\s*$/.test(it.title)) ? it.title : 'User Report';
        li.appendChild(a); ulUser.appendChild(li);
      }

      // Build League Reports (sort newest first by time, then sort key)
      league.sort((a,b)=> {
        const dt = safeDate(b) - safeDate(a); if (dt!==0) return dt; return String((b.sort||'')).localeCompare(String(a.sort||''));
      });
      for(const it of league){
        const li = document.createElement('li'); li.className='leaf item';
        li.setAttribute('data-range','league'); li.setAttribute('data-time', String(safeDate(it)));
        const a = document.createElement('a'); a.href = normHref(it.href||'#');
        a.textContent = (it.title && !/^\s*$/.test(it.title)) ? it.title : 'League';
        li.appendChild(a); ulLeague.appendChild(li);
      }

      // Refresh clickable leaves and list for navigation
      items = Array.from(list.querySelectorAll('.leaf.item'));
      wireItemClicks();
    } catch (e) {
      console.warn('Failed to load reports.json', e);
    } finally {
      if(spin) spin.style.display='none';
    }
  }

  async function init(){
  await loadReports();
  const file = new URLSearchParams(location.hash.replace(/^#/, '')).get('file');
    if (file){ const t=items.find(li => li.querySelector('a')?.getAttribute('href')===file); if (t){ const v=items; const idx=v.indexOf(t); if (idx>=0){ select(idx); return; } } }
    apply();
  }
  init();
})();
</script>
<script>
// Hovercard accessibility: toggle on focus/Enter, close on Esc and on blur
(function(){
  const triggers = Array.from(document.querySelectorAll('.has-hover'));
  // Assign ids and aria controls
  triggers.forEach((wrap, i)=>{
    const card = wrap.querySelector('.hovercard'); if(!card) return;
    const id = card.id || `hovercard-${i+1}`; card.id = id;
    // Make the wrapper focusable (acts as trigger)
    wrap.setAttribute('tabindex','0');
    wrap.setAttribute('role','button');
    wrap.setAttribute('aria-controls', id);
    wrap.setAttribute('aria-expanded','false');
    // Open helpers
    function open(){ wrap.classList.add('open'); wrap.setAttribute('aria-expanded','true'); }
    function close(){ wrap.classList.remove('open'); wrap.setAttribute('aria-expanded','false'); }
    wrap.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); if(wrap.classList.contains('open')) close(); else open(); }
      if(e.key==='Escape'){ e.preventDefault(); close(); wrap.focus(); }
      if(e.key==='ArrowDown'){ if(!wrap.classList.contains('open')) open(); const first = card.querySelector('a,button,[tabindex]'); if(first) first.focus(); }
    });
    wrap.addEventListener('blur', (e)=>{ if(!wrap.contains(e.relatedTarget)){ close(); } }, true);
    card.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ e.preventDefault(); close(); wrap.focus(); } });
  });
})();
</script>
</body>
</html>
